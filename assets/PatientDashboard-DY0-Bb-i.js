import{d as e,y as t,u as a,q as s,T as r}from"./vendor-CGONjlB7.js";import{d as l,e as i}from"./services-C1O7jNhA.js";import{P as n}from"./index-BW7VikAO.js";import{u as d,C as c,A as o,P as m,B as h,e as p,f as g,S as x,M as u,L as v,d as f,V as y}from"./ui-rlgsdZfQ.js";import"./database-DJZASbgB.js";function w({isOpen:s,onClose:r,onDataChanged:n}){const{t:v}=d(),[f,y]=e([]),[w,b]=e(new Set),[N,k]=e(null),[M,C]=e(!1),[S,D]=e({show:!1,progress:0,message:""});t(()=>{s&&L()},[s]);const L=async()=>{C(!0);try{const[e,t]=await Promise.all([l.getAllPatients(),l.getStorageStats()]);y(e),k(t)}catch(e){i.handleError({type:"data",code:"DATA_LOAD_FAILED",message:"Failed to load data management information",details:e,timestamp:new Date,recoverable:!0})}finally{C(!1)}},E=(e,t)=>{const a=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)},P=e=>new Promise((t,a)=>{const s=new FileReader;s.onload=e=>t(e.target?.result),s.onerror=()=>a(new Error("Failed to read file")),s.readAsText(e)}),T=e=>{switch(e){case"red":return"text-red-600";case"yellow":return"text-yellow-600";case"green":return"text-green-600";default:return"text-gray-600"}};return s?a(u,{isOpen:s,onClose:r,title:v("dataManagement.title"),size:"xl",children:a("div",{class:"space-y-6",children:[N&&a(c,{variant:"outlined",padding:"md",children:[a("h3",{class:"text-lg font-semibold text-medical-text-primary mb-4",children:v("dataManagement.storageStats")}),a("div",{class:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[a("div",{class:"text-center",children:[a("div",{class:"text-2xl font-bold text-medical-primary",children:N.totalPatients}),a("div",{class:"text-sm text-medical-text-secondary",children:v("dataManagement.totalPatients")})]}),a("div",{class:"text-center",children:[a("div",{class:"text-2xl font-bold text-medical-accent",children:(e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(2))} ${["Bytes","KB","MB","GB"][t]}`})(N.storageUsed)}),a("div",{class:"text-sm text-medical-text-secondary",children:v("dataManagement.storageUsed")})]}),a("div",{class:"text-center",children:[a("div",{class:"text-lg font-semibold text-medical-success",children:N.patientsByStatus.active||0}),a("div",{class:"text-sm text-medical-text-secondary",children:v("dataManagement.activePatients")})]}),a("div",{class:"text-center",children:[a("div",{class:"text-lg font-semibold text-medical-warning",children:N.patientsByStatus.treated||0}),a("div",{class:"text-sm text-medical-text-secondary",children:v("dataManagement.treatedPatients")})]})]})]}),S.show&&a(o,{variant:"info",children:a("div",{class:"space-y-2",children:[a("div",{class:"text-sm font-medium",children:S.message}),a(m,{progress:S.progress})]})}),a(c,{variant:"outlined",padding:"md",children:[a("h3",{class:"text-lg font-semibold text-medical-text-primary mb-4",children:v("dataManagement.backupRestore")}),a("div",{class:"flex flex-col sm:flex-row gap-4",children:[a(h,{variant:"outline",onClick:async()=>{C(!0);try{const e=await l.exportData();E(e,`triage-backup-${(new Date).toISOString().split("T")[0]}.json`),i.showToast("Data exported successfully","success")}catch(e){i.handleError({type:"data",code:"EXPORT_FAILED",message:"Failed to export data",details:e,timestamp:new Date,recoverable:!0})}finally{C(!1)}},disabled:M||0===f.length,className:"flex-1",children:v("dataManagement.exportAll")}),a(p,{accept:".json",onChange:e=>e&&(async e=>{D({show:!0,progress:0,message:"Reading file..."});try{const t=await P(e);D({show:!0,progress:25,message:"Validating data..."}),JSON.parse(t),D({show:!0,progress:50,message:"Importing patients..."});const a=await l.importData(t);D({show:!0,progress:100,message:"Import complete!"}),setTimeout(()=>{D({show:!1,progress:0,message:""}),a.errors.length>0?i.showToast(`Imported ${a.imported} patients. ${a.errors.length} errors occurred.`,"warning"):i.showToast(`Successfully imported ${a.imported} patients`,"success"),L(),n()},1e3)}catch(t){D({show:!1,progress:0,message:""}),i.handleError({type:"data",code:"IMPORT_FAILED",message:"Failed to import data",details:t,timestamp:new Date,recoverable:!0})}})(e),disabled:M,className:"flex-1",children:v("dataManagement.importData")})]}),a("div",{class:"mt-2 text-xs text-medical-text-secondary",children:v("dataManagement.backupNote")})]}),f.length>0&&a(c,{variant:"outlined",padding:"md",children:[a("div",{class:"flex items-center justify-between mb-4",children:[a("h3",{class:"text-lg font-semibold text-medical-text-primary",children:v("dataManagement.bulkOperations")}),a("div",{class:"flex items-center gap-4",children:[a(g,{checked:w.size===f.length,indeterminate:w.size>0&&w.size<f.length,onChange:e=>{b(e?new Set(f.map(e=>e.id)):new Set)},label:v("dataManagement.selectAll")}),a("span",{class:"text-sm text-medical-text-secondary",children:[w.size," ",v("dataManagement.selected")]})]})]}),w.size>0&&a("div",{class:"flex flex-wrap gap-2 mb-4 p-3 bg-gray-50 rounded-lg",children:[a(x,{value:"",onChange:e=>e&&(async e=>{if(0!==w.size){C(!0);try{const t=await l.bulkUpdatePatientStatus(Array.from(w),e);t.errors.length>0?i.showToast(`Updated ${t.updated} patients. ${t.errors.length} errors occurred.`,"warning"):i.showToast(`Successfully updated ${t.updated} patients to ${e}`,"success"),b(new Set),await L(),n()}catch(t){i.handleError({type:"data",code:"BULK_UPDATE_FAILED",message:"Failed to update patient status",details:t,timestamp:new Date,recoverable:!0})}finally{C(!1)}}})(e),disabled:M,placeholder:v("dataManagement.updateStatus"),className:"min-w-40",children:[a("option",{value:"treated",children:v("status.treated")}),a("option",{value:"transferred",children:v("status.transferred")}),a("option",{value:"discharged",children:v("status.discharged")})]}),a(h,{variant:"outline",onClick:async()=>{if(0!==w.size){C(!0);try{const e=await l.bulkExportPatients(Array.from(w));E(e,`triage-selected-${w.size}-patients-${(new Date).toISOString().split("T")[0]}.json`),i.showToast(`Exported ${w.size} patients successfully`,"success")}catch(e){i.handleError({type:"data",code:"EXPORT_SELECTED_FAILED",message:"Failed to export selected patients",details:e,timestamp:new Date,recoverable:!0})}finally{C(!1)}}},disabled:M,size:"sm",children:v("dataManagement.exportSelected")}),a(h,{variant:"danger",onClick:async()=>{if(0!==w.size){C(!0);try{const e=await l.bulkDeletePatients(Array.from(w));e.errors.length>0?i.showToast(`Deleted ${e.deleted} patients. ${e.errors.length} errors occurred.`,"warning"):i.showToast(`Successfully deleted ${e.deleted} patients`,"success"),b(new Set),await L(),n()}catch(e){i.handleError({type:"data",code:"BULK_DELETE_FAILED",message:"Failed to delete patients",details:e,timestamp:new Date,recoverable:!0})}finally{C(!1)}}},disabled:M,size:"sm",children:v("dataManagement.deleteSelected")})]}),a("div",{class:"max-h-96 overflow-y-auto",children:a("div",{class:"space-y-2",children:f.map(e=>a("div",{class:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50",children:[a(g,{checked:w.has(e.id),onChange:t=>((e,t)=>{const a=new Set(w);t?a.add(e):a.delete(e),b(a)})(e.id,t)}),a("div",{class:"flex-1 min-w-0",children:[a("div",{class:"flex items-center gap-2",children:[a("span",{class:"font-mono text-sm font-medium",children:["#",e.id.slice(0,8).toUpperCase()]}),a("span",{class:`text-sm font-medium ${T(e.priority.level)}`,children:e.priority.level.toUpperCase()}),a("span",{class:"text-sm text-medical-text-secondary",children:v(`status.${e.status}`)})]}),a("div",{class:"text-xs text-medical-text-secondary",children:[e.timestamp.toLocaleDateString()," â€¢"," ",e.ageGroup]})]})]},e.id))})})]}),M&&a("div",{class:"text-center py-4",children:a("div",{class:"text-medical-text-secondary",children:[v("common.loading"),"..."]})})]})}):null}function b(){return"undefined"!=typeof navigator&&(navigator.hardwareConcurrency||2)<=2?10:20}function N({onPatientSelect:i,onPatientUpdate:o,className:m=""}){const{t:p}=d(),[g,x]=e([]),[u,N]=e(!0),[k,M]=e(null),[C,S]=e("priority"),[D,L]=e("all"),[E,P]=e(!1);t(()=>{T()},[]);const T=async()=>{try{N(!0),M(null);const e=await l.getAllPatients();x(e)}catch(e){M(p("toast.errorOccurred"))}finally{N(!1)}},$=s(e=>{i&&i(e)},[i]),z=s(async(e,t)=>{try{await l.updatePatient(e,t),x(a=>a.map(a=>a.id===e?{...a,...t,lastUpdated:new Date}:a)),o&&o(e,t)}catch(a){M(p("toast.errorOccurred"))}},[o,p]),A=r(()=>{let e=g;return"all"!==D&&(e=g.filter(e=>e.priority.level===D)),e.sort((e,t)=>"priority"===C?e.priority.urgency-t.priority.urgency:t.timestamp.getTime()-e.timestamp.getTime())},[g,D,C]),B=r(()=>{const e={red:0,yellow:0,green:0,black:0,total:g.length};return g.forEach(t=>{e[t.priority.level]++}),e},[g]);return a("div",u?{className:`flex items-center justify-center p-8 ${m}`,children:a(v,{size:"lg",label:p("common.loading")})}:k?{className:`p-4 ${m}`,children:a(c,{variant:"outlined",padding:"md",children:a("div",{className:"flex items-start",children:[a("div",{className:"flex-shrink-0",children:a("svg",{className:"h-5 w-5 text-medical-error",viewBox:"0 0 20 20",fill:"currentColor",children:a("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),a("div",{className:"ml-3 flex-1",children:[a("h3",{className:"text-sm font-medium text-medical-error",children:p("common.error")}),a("p",{className:"text-sm text-medical-text-secondary mt-1",children:k}),a(h,{variant:"outline",size:"sm",onClick:T,className:"mt-3",children:p("common.tryAgain")})]})]})})}:{className:`space-y-4 sm:space-y-6 ${m}`,children:[a(c,{variant:"default",padding:"md",children:a("div",{className:"flex flex-col gap-4",children:[a("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[a("div",{children:[a("h2",{className:"text-responsive-xl font-bold text-medical-text-primary",children:p("dashboard.title")}),a("p",{className:"text-medical-text-secondary mt-1 text-responsive-sm",children:[p("dashboard.totalPatients"),": ",B.total]})]}),a("div",{className:"flex gap-2",children:a(h,{variant:"outline",size:"sm",onClick:()=>P(!0),className:"shrink-0",children:[a("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 7v10c0 2.21 3.79 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.79 4 8 4s8-1.79 8-4M4 7c0-2.21 3.79-4 8-4s8 1.79 8 4"})}),p("dashboard.dataManagement")]})})]}),a(f,{cols:{xs:2,sm:4},gap:"sm",className:"mt-4",children:[a("div",{className:"flex items-center space-x-2 bg-red-50 text-red-700 px-3 py-2 rounded-lg text-sm font-medium",children:[a("div",{className:"w-3 h-3 bg-triage-red rounded-full flex-shrink-0"}),a("span",{className:"truncate",children:[B.red," ",p("triage.red")]})]}),a("div",{className:"flex items-center space-x-2 bg-yellow-50 text-yellow-700 px-3 py-2 rounded-lg text-sm font-medium",children:[a("div",{className:"w-3 h-3 bg-triage-yellow rounded-full flex-shrink-0"}),a("span",{className:"truncate",children:[B.yellow," ",p("triage.yellow")]})]}),a("div",{className:"flex items-center space-x-2 bg-green-50 text-green-700 px-3 py-2 rounded-lg text-sm font-medium",children:[a("div",{className:"w-3 h-3 bg-triage-green rounded-full flex-shrink-0"}),a("span",{className:"truncate",children:[B.green," ",p("triage.green")]})]}),a("div",{className:"flex items-center space-x-2 bg-gray-50 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium",children:[a("div",{className:"w-3 h-3 bg-triage-black rounded-full flex-shrink-0"}),a("span",{className:"truncate",children:[B.black," ",p("triage.black")]})]})]})]})}),a(c,{variant:"default",padding:"sm",children:a("div",{className:"flex flex-col sm:flex-row gap-3 sm:gap-4",children:[a("div",{className:"flex items-center space-x-2 flex-1",children:[a("label",{className:"text-sm font-medium text-medical-text-primary shrink-0",children:[p("dashboard.sortBy"),":"]}),a("select",{value:C,onChange:e=>S(e.currentTarget.value),className:"form-select text-sm flex-1 min-w-0",children:[a("option",{value:"priority",children:p("dashboard.sortByPriority")}),a("option",{value:"timestamp",children:p("dashboard.sortByTime")})]})]}),a("div",{className:"flex items-center space-x-2 flex-1",children:[a("label",{className:"text-sm font-medium text-medical-text-primary shrink-0",children:[p("dashboard.filters"),":"]}),a("select",{value:D,onChange:e=>L(e.currentTarget.value),className:"form-select text-sm flex-1 min-w-0",children:[a("option",{value:"all",children:p("dashboard.all")}),a("option",{value:"red",children:p("triage.red")}),a("option",{value:"yellow",children:p("triage.yellow")}),a("option",{value:"green",children:p("triage.green")}),a("option",{value:"black",children:p("triage.black")})]})]}),a(h,{variant:"outline",size:"sm",onClick:T,className:"shrink-0",children:[a("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),p("dashboard.refresh")]})]})}),a("div",{children:0===A.length?a(c,{variant:"default",padding:"lg",className:"text-center",children:[a("div",{className:"text-medical-text-muted mb-4",children:a("svg",{className:"mx-auto h-12 w-12 sm:h-16 sm:w-16",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:a("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})})}),a("h3",{className:"text-responsive-lg font-medium text-medical-text-primary mb-2",children:p("dashboard.noPatients")}),a("p",{className:"text-medical-text-secondary text-responsive-sm max-w-md mx-auto",children:"all"===D?p("dashboard.noPatientsSub"):`${p("dashboard.noPatientsFilter")} ${D}`})]}):A.length>b()?a(y,{items:A,itemHeight:180,containerHeight:600,renderItem:e=>a("div",{className:"mb-3",children:a(n,{patient:e,onClick:()=>$(e.id),onStatusUpdate:t=>z(e.id,{status:t})})},e.id),className:"rounded-lg"}):a("div",{className:"space-y-3",children:A.map(e=>a("div",{className:"animate-slide-up",children:a(n,{patient:e,onClick:()=>$(e.id),onStatusUpdate:t=>z(e.id,{status:t})})},e.id))})}),a(w,{isOpen:E,onClose:()=>P(!1),onDataChanged:T})]})}export{N as PatientDashboard};
